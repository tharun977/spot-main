{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% block title %}Manage Parking Places{% endblock %}
{% block content %}

<h2 class="my-4 text-center">Manage Parking Places</h2>

<!-- Parking Place Form -->
<form method="post" action="{% url 'manage_parking_places' %}" class="mb-4">
    {% csrf_token %}
    <input type="hidden" name="add_place" value="1">
    <div class="row g-3">
        <div class="col-md-6">{{ place_form.place_name|as_crispy_field }}</div>
        <div class="col-md-6">{{ place_form.location|as_crispy_field }}</div>
        <div class="col-md-4">{{ place_form.capacity|as_crispy_field }}</div>
        <div class="col-md-4">{{ place_form.available_spaces|as_crispy_field }}</div>
        <div class="col-md-4">{{ place_form.status|as_crispy_field }}</div>
    </div>
    <button type="submit" class="btn btn-primary mt-3">Add Parking Place</button>
</form>

<!-- Parking Places Table -->
<h3>Available Parking Places</h3>
<table class="table table-striped table-bordered text-center">
    <thead>
        <tr>
            <th>Place Name</th>
            <th>Location</th>
            <th>Capacity</th>
            <th>Available Spaces</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for parking_place in parking_places %}
        <tr>
            <td>{{ parking_place.place_name }}</td>
            <td>{{ parking_place.location }}</td>
            <td>{{ parking_place.capacity }}</td>
            <td>{{ parking_place.available_spaces }}</td>
            <td>{{ parking_place.status|yesno:"Active,Inactive" }}</td>
            <td>
                <a href="{% url 'edit_parking_place' parking_place.pk %}" class="btn btn-warning btn-sm">Edit</a>
                <form method="post" action="{% url 'delete_parking_place' parking_place.pk %}" class="d-inline" onsubmit="return confirmDelete();">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                </form>
                <!-- More Details Button -->
                <button class="btn btn-info btn-sm" onclick="toggleDetails('{{ parking_place.pk }}')">
                    More Details â–¼
                </button>
            </td>
        </tr>

        <!-- Expandable Row for Details -->
        <tr id="detailsRow{{ parking_place.pk }}" class="details-row">
            <td colspan="6">
                <div class="details-container">
                    <h5>{{ parking_place.place_name }} - Details</h5>
                    <p><strong>Lot ID:</strong> {{ parking_place.lot_id }}</p>
                    <p><strong>Place ID:</strong> {{ parking_place.pk }}</p>
                    <p><strong>Vehicle Type ID:</strong> {{ parking_place.lvehicle_type_id }}</p>
                    <p><strong>Status:</strong> {{ parking_place.status|yesno:"Active,Inactive" }}</p>

                    {% with parking_fees|dictsort:"vehicle_type" as sorted_fees %}
                        {% if sorted_fees %}
                            <h6 class="mt-3">Parking Fees:</h6>
                            <ul class="list-unstyled">
                                {% for fee in sorted_fees %}
                                    {% if fee.parking_place == parking_place %}
                                        <li>ðŸš— {{ fee.vehicle_type }}: â‚¹{{ fee.fee }}</li>
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        {% endif %}
                    {% endwith %}
                </div>
            </td>
        </tr>
        {% empty %}
        <tr><td colspan="6" class="text-center">No parking places available.</td></tr>
        {% endfor %}
    </tbody>
</table>

<style>
    ::-webkit-scrollbar {
        display: none;
    }
    body {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .details-row {
        display: none;
        background-color: #f8f9fa;
        transition: all 0.3s ease-in-out;
    }
    .details-container {
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: white;
    }
</style>

<!-- Confirm Delete Script -->
<script>
    function confirmDelete() {
        return confirm("Do you want to delete this parking place?");
    }

    function toggleDetails(id) {
        const row = document.getElementById(`detailsRow${id}`);
        if (row.style.display === "none" || row.style.display === "") {
            row.style.display = "table-row"; // Show details
        } else {
            row.style.display = "none"; // Hide details
        }
    }
</script>

{% endblock %}
